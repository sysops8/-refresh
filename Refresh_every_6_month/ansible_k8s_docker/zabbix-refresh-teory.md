# Zabbix: Курс-напоминание для DevOps/SysAdmin

## Введение
Этот курс предназначен для периодического освежения знаний по Zabbix. Рекомендуется проходить раз в 6-12 месяцев.

---

## Модуль 1: Основы архитектуры Zabbix

### Компоненты системы
Zabbix состоит из нескольких ключевых компонентов, которые работают вместе для обеспечения мониторинга инфраструктуры.

**Zabbix Server** — центральный компонент, который собирает данные, обрабатывает триггеры, отправляет уведомления и хранит конфигурацию. Это мозг всей системы мониторинга.

**Zabbix Agent** — программа, устанавливаемая на мониторируемые хосты. Собирает локальные метрики (CPU, память, диск) и отправляет их на сервер. Работает в двух режимах: активном (агент сам отправляет данные) и пассивном (сервер запрашивает данные).

**Zabbix Proxy** — опциональный компонент для распределенного мониторинга. Собирает данные от агентов и передает их на центральный сервер. Полезен для мониторинга удаленных локаций или снижения нагрузки на основной сервер.

**Web-интерфейс** — фронтенд для управления конфигурацией, просмотра данных, настройки дашбордов и получения отчетов.

**База данных** — хранит всю конфигурацию, исторические данные и события. Поддерживаются MySQL/MariaDB, PostgreSQL, Oracle.

### Типы мониторинга
Zabbix поддерживает несколько подходов к сбору данных, каждый из которых имеет свои преимущества.

**Zabbix Agent** — наиболее распространенный способ мониторинга. Обеспечивает детальный сбор метрик операционной системы с минимальными накладными расходами.

**SNMP** — стандартный протокол для мониторинга сетевого оборудования (коммутаторы, маршрутизаторы, принтеры). Поддерживает SNMPv1, v2c и v3.

**IPMI** — мониторинг аппаратного обеспечения серверов (температура, вентиляторы, питание) через контроллеры управления.

**JMX** — мониторинг Java-приложений через Java Management Extensions.

**Simple checks** — простые проверки без агента: ICMP ping, TCP/UDP порты, доступность HTTP/HTTPS.

**External checks** — выполнение внешних скриптов на Zabbix Server для специфических проверок.

**Database monitoring** — прямые SQL-запросы к базам данных для мониторинга производительности СУБД.

---

## Модуль 2: Основные концепции

### Иерархия объектов
Понимание иерархии объектов в Zabbix критично для эффективной организации мониторинга.

**Host groups** — логические группы хостов (например, "Linux servers", "Web servers", "Production"). Используются для организации, массовых операций и настройки прав доступа.

**Hosts** — мониторируемые устройства или сервисы. Каждый хост принадлежит одной или нескольким группам.

**Applications** — способ группировки элементов данных по функциональному назначению (CPU, Memory, Network). В новых версиях Zabbix заменены на теги.

**Items** — конкретные метрики, которые собираются (например, "CPU utilization", "Free disk space"). Каждый item имеет тип, ключ, интервал обновления и единицы измерения.

**Triggers** — условия, определяющие проблемы (например, "CPU usage > 90% for 5 minutes"). Имеют уровни severity: Not classified, Information, Warning, Average, High, Disaster.

**Events** — изменения состояния триггеров, создаваемые когда условия выполняются или перестают выполняться.

**Actions** — автоматические реакции на события: отправка уведомлений, выполнение команд, создание тикетов.

### Templates
Шаблоны являются основой масштабируемого мониторинга в Zabbix.

Шаблон содержит набор items, triggers, graphs, discovery rules и других элементов, которые можно применить к множеству хостов одновременно. Изменения в шаблоне автоматически применяются ко всем связанным хостам.

**Вложенность шаблонов** — шаблоны могут наследоваться друг от друга, создавая иерархию. Например, базовый шаблон "Linux OS" может быть расширен шаблоном "Linux Web Server".

**Стандартные шаблоны** — Zabbix поставляется с обширной библиотекой готовых шаблонов для популярных ОС, приложений и устройств.

**Кастомизация** — можно переопределять элементы шаблона на уровне хоста без изменения самого шаблона.

---

## Модуль 3: Практические навыки

### Создание базового мониторинга
Давайте пройдем процесс настройки мониторинга нового сервера.

Сначала создайте host group, если нужно: Configuration → Host groups → Create host group. Дайте осмысленное имя группе, отражающее назначение серверов.

Добавьте новый хост: Configuration → Hosts → Create host. Укажите имя хоста, добавьте его в группы, настройте интерфейсы (Agent, SNMP, JMX, IPMI). Для Agent-интерфейса укажите IP или DNS и порт (по умолчанию 10050).

Привяжите шаблоны к хосту. Для Linux-сервера обычно используется "Linux by Zabbix agent" или аналогичный. Можно добавить несколько шаблонов одновременно.

После сохранения дождитесь, пока в столбце "Availability" появится зеленая иконка ZBX, что означает успешное подключение к агенту.

### Создание custom item
Иногда стандартных метрик недостаточно, и нужно создать собственные.

Перейдите к хосту или шаблону: Configuration → Hosts → Items → Create item.

Основные параметры для настройки включают Name (человекочитаемое имя метрики), Type (Zabbix agent, SNMP, calculated и т.д.), Key (уникальный идентификатор item), Type of information (numeric, character, log, text), Units (секунды, байты, %), Update interval (как часто собирать данные).

Пример ключа для мониторинга количества процессов: `proc.num[nginx]` — подсчитает процессы nginx.

Для мониторинга пользовательских метрик через агент можно использовать UserParameter в конфигурации агента или system.run для выполнения команд.

### Создание триггера
Триггеры превращают данные в оповещения о проблемах.

Перейдите к items и нажмите "Create trigger" рядом с нужным item, или создайте через Configuration → Hosts → Triggers → Create trigger.

**Выражения триггеров** используют функции для анализа данных. Примеры распространенных функций: `last()` — последнее значение, `avg()` — среднее за период, `min()`/`max()` — минимум/максимум, `change()` — изменилось ли значение, `nodata()` — нет данных за период.

Пример триггера для высокой загрузки CPU: `avg(/Linux server/system.cpu.util,5m) > 90` — средняя загрузка CPU за 5 минут больше 90%.

Пример триггера для заполнения диска: `last(/Linux server/vfs.fs.size[/,pfree]) < 10` — свободно менее 10% на корневом разделе.

**Severity** определяет важность проблемы и влияет на приоритет уведомлений и визуальное отображение.

### Low-level discovery (LLD)
Автоматическое обнаружение позволяет динамически создавать items для изменяющихся объектов.

LLD используется для автоматического мониторинга файловых систем, сетевых интерфейсов, процессов, контейнеров и других динамических сущностей.

Discovery rule возвращает JSON с макросами, которые затем используются в прототипах items, triggers и graphs. Например, обнаружение файловых систем возвращает `{#FSNAME}`, `{#FSTYPE}` и другие макросы.

Стандартные discovery rules уже включены в шаблоны, но можно создавать собственные. Настройки discovery rule включают ключ для обнаружения, интервал обновления, фильтры для включения/исключения объектов, Keep lost resources period (как долго хранить исчезнувшие объекты).

После создания rule добавьте Item prototypes, Trigger prototypes и Graph prototypes, используя макросы из discovery.

---

## Модуль 4: Мониторинг производительности

### Ключевые метрики Linux
Для эффективного мониторинга Linux-серверов важно отслеживать следующие метрики.

**CPU**: `system.cpu.util` (общая загрузка), `system.cpu.util[,idle]` (простой), `system.cpu.load` (load average). Обращайте внимание на load average: значения выше количества ядер указывают на перегрузку.

**Memory**: `vm.memory.size[available]` (доступная память), `vm.memory.size[pavailable]` (процент доступной), `system.swap.size[,pfree]` (swap). Активное использование swap обычно указывает на нехватку RAM.

**Disk**: `vfs.fs.size[/,used]` (использованное место), `vfs.fs.size[/,pfree]` (процент свободного), `vfs.fs.inode[/,pfree]` (свободные inodes), `vfs.dev.read/write` (операции чтения/записи).

**Network**: `net.if.in/out[eth0]` (входящий/исходящий трафик), `net.if.total[eth0]` (общий трафик), `net.tcp.listen[80]` (прослушиваемые порты).

**Processes**: `proc.num[]` (общее количество), `proc.num[,,run]` (запущенные), `proc.num[apache2]` (по имени процесса).

### Метрики приложений
Мониторинг приложений часто требует специфических подходов.

**Web-серверы (Nginx/Apache)**: используйте модуль stub_status для Nginx или mod_status для Apache. Мониторьте активные соединения, requests per second, upstream статус.

**Базы данных**: для MySQL/PostgreSQL отслеживайте количество соединений, slow queries, buffer pool usage, replication lag. Используйте ODBC или native checks.

**Docker/Kubernetes**: мониторьте состояние контейнеров, использование ресурсов, количество рестартов. Zabbix поддерживает Docker и Kubernetes через специальные шаблоны.

**Custom приложения**: используйте Zabbix sender для отправки метрик из приложений, или настройте HTTP agent для опроса REST API приложения.

### Графики и дашборды
Визуализация данных помогает быстро оценить состояние системы.

**Graphs** создаются автоматически для многих items, но можно создавать кастомные: Monitoring → Hosts → Graphs → Create graph. Добавьте несколько items на один график для корреляции (например, CPU и load average).

**Dashboards** — настраиваемые панели мониторинга. Создайте дашборд: Monitoring → Dashboards → Create dashboard. Добавляйте виджеты: Graphs, Plain text, Clock, Map, Problems и другие.

**Screen** (в старых версиях) или **Dashboard widgets** позволяют создать обзорную панель для команды NOC с ключевыми метриками и статусом систем.

---

## Модуль 5: Алертинг и автоматизация

### Настройка уведомлений
Правильная настройка алертинга критична для быстрого реагирования на проблемы.

Сначала настройте Media types: Administration → Media types. Zabbix поддерживает Email, SMS, Slack, Telegram, PagerDuty, webhooks и другие. Для Email настройте SMTP-сервер, порт, аутентификацию.

Создайте или настройте пользователей: Administration → Users. В разделе Media добавьте способ связи (email, номер телефона) и укажите, когда пользователь должен получать уведомления (always, или определенные часы/дни).

Настройте User groups и права доступа. Группы определяют, какие хосты и проблемы видит пользователь.

### Actions и эскалации
Actions определяют, что происходит при возникновении проблемы.

Создайте action: Configuration → Actions → Trigger actions → Create action.

В условиях (Conditions) определите, когда action срабатывает: по группе хостов, severity, имени триггера, времени суток и другим параметрам.

В операциях (Operations) настройте действия: отправка сообщения пользователю или группе, выполнение remote команды, создание тикета в ITSM.

**Эскалация** позволяет усиливать уведомления: например, через 15 минут после первого алерта уведомить старшего администратора, через 30 минут — менеджера.

Настройте Recovery operations для уведомления о решении проблемы и Update operations для уведомлений об изменениях в проблеме.

### Remote commands
Zabbix может автоматически выполнять команды при возникновении проблем.

В action operations добавьте "Remote command". Выберите тип: Custom script, IPMI, SSH, Telnet, Global script.

Пример: автоматический рестарт службы при падении. Команда: `systemctl restart nginx`. Настройте Execute on: Zabbix agent (команда выполнится на проблемном хосте).

**Безопасность**: будьте осторожны с remote commands, они могут быть опасны. Используйте их только для безопасных, идемпотентных операций. Включите логирование всех выполненных команд.

---

## Модуль 6: Продвинутые техники

### Макросы и функции
Макросы делают конфигурацию более гибкой и переиспользуемой.

**User macros** определяются на уровне глобальном, template или host: `{$MACRO_NAME}`. Используются для пороговых значений, интервалов, IP-адресов. Пример: `{$CPU.UTIL.MAX}=90` в шаблоне, можно переопределить для конкретного хоста.

**Built-in macros** предоставляются Zabbix: `{HOST.NAME}`, `{ITEM.VALUE}`, `{TRIGGER.STATUS}`, `{EVENT.DATE}` и другие. Используются в уведомлениях и командах.

**Функции триггеров** включают математические операции, сравнения, логические операторы. Сложные выражения: `avg(/host/item,5m) > 80 and change(/host/item) > 10` — средняя за 5 минут больше 80 И изменение больше 10.

### Calculated и dependent items
Эти типы items позволяют создавать производные метрики.

**Calculated items** вычисляются на основе других items без опроса агента. Формула использует арифметические операции и функции. Пример: `last("//system.cpu.util[,user]") + last("//system.cpu.util[,system]")` — суммарная загрузка CPU пользователем и системой.

**Dependent items** создаются из одного master item через preprocessing. Это эффективно для парсинга JSON/XML ответов или обработки логов. Один HTTP-запрос может создать множество метрик через dependent items.

### Zabbix API
API позволяет автоматизировать управление Zabbix через скрипты.

API использует JSON-RPC 2.0 через HTTP POST. Сначала аутентифицируйтесь, получите токен, затем используйте его для запросов.

Основные методы включают `host.get`, `host.create`, `item.get`, `trigger.get`, `alert.get` и множество других.

Используйте API для массового добавления хостов, создания отчетов, интеграции с CMDB или системами автоматизации (Ansible, Terraform).

Библиотеки для разных языков упрощают работу: pyzabbix (Python), ruby-zabbix-api (Ruby), zabbix-api (Go).

---

## Модуль 7: Обслуживание и оптимизация

### Housekeeping и производительность
Правильная настройка хранения данных предотвращает разрастание базы.

Housekeeping автоматически удаляет старые данные. Настройка: Administration → General → Housekeeping. Определите сроки хранения для History, Trends, Events, Alerts.

**History** — детальные данные, обычно хранятся 7-30 дней. **Trends** — агрегированные почасовые данные, хранятся 365-730 дней.

Партиционирование таблиц БД значительно улучшает производительность больших инсталляций. Используйте скрипты партиционирования для MySQL/PostgreSQL.

Оптимизация производительности включает увеличение кеша Zabbix (CacheSize, HistoryCacheSize), тюнинг БД (innodb_buffer_pool_size для MySQL), использование TimescaleDB для PostgreSQL, настройку полеров и тредов (StartPollers, StartPingers).

### Backup и восстановление
Регулярные бэкапы защищают от потери данных и конфигурации.

Создавайте резервные копии базы данных регулярно: `mysqldump zabbix > zabbix_backup.sql` или `pg_dump zabbix > zabbix_backup.sql`.

Сохраняйте конфигурационные файлы: `/etc/zabbix/zabbix_server.conf`, `/etc/zabbix/zabbix_agentd.conf`, `/etc/zabbix/web/zabbix.conf.php`.

Экспортируйте конфигурацию шаблонов и хостов через веб-интерфейс или API для версионирования.

Для восстановления: остановите Zabbix Server, восстановите БД, восстановите конфиги, запустите сервер. Проверьте логи на наличие ошибок.

### Обновление Zabbix
Регулярные обновления обеспечивают безопасность и новые функции.

Всегда читайте Release Notes перед обновлением. Проверьте breaking changes и требования к БД/PHP.

Процесс обновления: создайте полный бэкап, остановите Zabbix Server и Agent, обновите пакеты/бинарники, БД будет обновлена автоматически при первом запуске сервера, обновите веб-интерфейс, запустите сервер и проверьте логи.

Для мажорных обновлений (например, 5.x → 6.x) внимательно изучите migration guide. Некоторые изменения могут требовать ручной корректировки конфигурации.

Тестируйте обновления в dev/stage окружении перед применением в продакшене.

---

## Модуль 8: Best Practices

### Организация мониторинга
Правильная структура облегчает управление и масштабирование.

Используйте осмысленную иерархию host groups: по окружению (Production/Staging/Dev), по функции (Web/DB/Cache), по локации (DC1/DC2/Cloud).

Стандартизируйте именование: хосты, items, triggers должны иметь понятные имена. Используйте префиксы для группировки.

Создавайте переиспользуемые шаблоны. Базовые шаблоны для ОС, специализированные для приложений. Используйте наследование шаблонов.

Документируйте кастомизацию в описаниях items и триггеров. Будущий вы (или коллеги) скажут спасибо.

### Типичные ошибки
Избегайте этих распространенных проблем.

**Слишком короткие интервалы опроса** создают излишнюю нагрузку. Не опрашивайте каждую секунду, если это не критично. Для большинства метрик достаточно 1-5 минут.

**Отсутствие фильтров в LLD** приводит к мониторингу ненужных объектов (временные файловые системы, виртуальные интерфейсы).

**Чрезмерный алертинг** вызывает усталость от уведомлений. Настраивайте разумные пороги и используйте dependencies между триггерами.

**Игнорирование dependencies** приводит к лавине алертов. Если сеть недоступна, не нужно уведомлять о каждом сервисе за ней.

**Отсутствие maintenance periods** во время плановых работ генерирует ложные алерты.

### Безопасность
Защита системы мониторинга критична.

Используйте HTTPS для веб-интерфейса. Настройте сертификаты и редирект с HTTP.

Включите шифрование между компонентами (Server-Agent, Server-Proxy) с помощью PSK или certificate-based encryption.

Настройте строгие пароли и регулярно их меняйте. Используйте двухфакторную аутентификацию, если доступна.

Ограничьте сетевой доступ: firewall правила для портов 10050 (agent), 10051 (server/proxy).

Регулярно обновляйте Zabbix и зависимости для закрытия уязвимостей.

Настройте логирование и мониторинг самого Zabbix. Мониторьте производительность сервера, размер БД, ошибки в логах.

---

## Чек-лист для проверки знаний

Пройдите этот чек-лист, чтобы убедиться в готовности:

- [ ] Могу объяснить разницу между active и passive checks
- [ ] Умею создать и настроить новый хост с агентом
- [ ] Могу создать custom item и триггер
- [ ] Понимаю, как работает LLD и могу настроить discovery rule
- [ ] Умею создать и настроить action с эскалацией
- [ ] Могу создать dashboard с нужными виджетами
- [ ] Знаю основные функции для триггеров (last, avg, min, max)
- [ ] Понимаю концепцию шаблонов и умею с ними работать
- [ ] Умею использовать макросы для гибкой конфигурации
- [ ] Знаю, как настроить housekeeping и оптимизировать производительность
- [ ] Могу сделать backup и восстановление Zabbix
- [ ] Понимаю основы безопасности Zabbix

---

## Полезные команды и ссылки

### Команды для диагностики
```bash
# Проверка статуса Zabbix Server
systemctl status zabbix-server

# Проверка статуса Zabbix Agent
systemctl status zabbix-agent

# Просмотр логов сервера
tail -f /var/log/zabbix/zabbix_server.log

# Просмотр логов агента
tail -f /var/log/zabbix/zabbix_agentd.log

# Проверка конфига агента
zabbix_agentd -t system.cpu.util

# Отправка данных через zabbix_sender
zabbix_sender -z zabbix-server -s "hostname" -k key -o value
```

### Полезные ссылки
- Официальная документация: https://www.zabbix.com/documentation
- Zabbix Share (шаблоны сообщества): https://www.zabbix.com/integrations
- Форум Zabbix: https://www.zabbix.com/forum

---

## Практическое задание

После прохождения курса выполните следующее задание для закрепления:

1. Разверните тестовый Zabbix Server (можно в Docker)
2. Установите агент на 2-3 тестовых хоста
3. Создайте кастомный шаблон для мониторинга веб-приложения
4. Настройте LLD для автоматического обнаружения сервисов
5. Создайте триггеры с разными severity levels
6. Настройте action с эскалацией уведомлений
7. Создайте dashboard с ключевыми метриками
8. Проверьте работу maintenance mode

**Время на выполнение**: 3-4 часа

---

*Курс обновлен: декабрь 2025. При следующем прохождении проверьте актуальность версии Zabbix и обновите при необходимости.*